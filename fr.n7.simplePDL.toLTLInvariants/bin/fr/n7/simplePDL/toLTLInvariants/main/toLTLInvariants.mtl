[comment encoding = UTF-8 /]
[module toLTLInvariants('http://simplepdl')]


[template public processtoLTL(aProcess : Process)]
[comment @main/]
[comment file : *-invariants.ltl/]
[file (aProcess.name + '-invariants.ltl', false, 'UTF-8')]
[comment WD/]
[let wds : OrderedSet(WorkDefinition) = aProcess.getWDs() ] 
	[if (wds->size() > 0)]
		[for (wd : WorkDefinition | wds)][comment
			/][wd.WriteWD()/]

		[/for]
	[/if]
[/let]

[comment WS/]
[let wss : OrderedSet(WorkSequence) = aProcess.getWSs() ] 
	[if (wss->size() > 0)]
		[for (wd : WorkSequence | wss)][comment
			/][wd.WriteWS()/]
		[/for]
	[/if]
[/let]
[/file]
[/template]

[template public WriteWD(wd : WorkDefinition) post (trim()) ]
[let name : String = wd.name ]
<> ([name + 'Ready'/] => [name + 'Running'/]);
<> ([name + 'Ready'/] => [name + 'Started'/]);
[name + 'Running'/] => [name + 'Finished'/];

['['/][']'/] [name + 'Ready + ' + name + 'Running + ' + name + 'Finished'/] = 1;
[/let]
[/template]

[template public WriteWS(ws : WorkSequence) post (trim()) ]
[let pred : String = ws.predecessor.name ]
	[let succ : String = ws.successor.name ]
		[if ws.linkType = WorkSequenceType::startToStart]
			[pred + 'Started'/] => [succ + 'Start'/];
		[else]
			[if ws.linkType = WorkSequenceType::finishToStart]
				[pred + 'Finished'/] => [succ + 'Start'/];
			[else]
				[if ws.linkType = WorkSequenceType::startToFinish]
					[pred + 'Started'/] => [succ + 'Finish'/];
				[else] [comment ws.linkType = WorkSequenceType::finishToFinish/]
					[pred + 'Finished'/] => [succ + 'Finish'/];
				[/if]
			[/if]
		[/if]
	[/let]
[/let]
[/template]


[query public getWDs(p: Process) : OrderedSet(WorkDefinition) = 
	p.processElements->select( e | e.oclIsTypeOf(WorkDefinition) )
		->collect( e | e.oclAsType(WorkDefinition) )
		->asOrderedSet()
/]
[query public getWSs(p: Process) : OrderedSet(WorkSequence) = 
	p.processElements->select( e | e.oclIsTypeOf(WorkSequence) )
		->collect( e | e.oclAsType(WorkSequence) )
		->asOrderedSet()
/]

